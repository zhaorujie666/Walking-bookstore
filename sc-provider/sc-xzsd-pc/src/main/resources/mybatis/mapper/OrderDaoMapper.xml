<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.xzsd.pc.order.dao.OrderDao">
    <!--查询订单列表（分页）-->
    <select id="getListOrder" parameterType="com.xzsd.pc.order.entity.OrderInfo"
            resultType="com.xzsd.pc.order.entity.OrderVO">
        select
            t1.id orderId,
            t1.total_price totalPrice,
            t1.order_status orderStatus,
            t1.defray_status defrayStatus,
            t1.store_id storeId,
            t2.user_name userName,
            t2.phone phone,
            t1.defray_time defrayTime,
            t1.version version
        from t_order_info t1, t_user t2
        where t1.user_id = t2.id
        and t1.is_delete = 0
        and t1.store_id = (select id
            from t_store_info
            where manager_id = #{loginId}
        )
        <if test="userName != null and userName != ''">
            and t2.user_name like concat('%', #{userName}, '%')
        </if>
        <if test="orderId != null and orderId != ''">
            and t1.id like concat('%', #{orderId}, '%')
        </if>
        <if test="defrayTimeStart != null and defrayTimeStart != '' and defrayTimeEnd != null and defrayTimeEnd != ''">
            and t1.defray_time between #{defrayTimeStart} and #{defrayTimeEnd}
        </if>
        <if test="phone != null and phone != ''">
            and t2.phone like concat('%', #{phone}, '%')
        </if>
        <if test="orderStatus != null and orderStatus != ''">
            and t1.order_status = #{orderStatus}
        </if>
    </select>

    <!--管理员查询全部订单（分页）-->
    <select id="getListOrderByAdmin" parameterType="com.xzsd.pc.order.entity.OrderInfo"
            resultType="com.xzsd.pc.order.entity.OrderVO">
        select
        t1.id orderId,
        t1.total_price totalPrice,
        t1.order_status orderStatus,
        t1.defray_status defrayStatus,
        t1.store_id storeId,
        t2.user_name userName,
        t2.phone phone,
        t1.defray_time defrayTime,
        t1.version version
        from t_order_info t1, t_user t2
        where t1.user_id = t2.id
        and t1.is_delete = 0
        <if test="userName != null and userName != ''">
            and t2.user_name like concat('%', #{userName}, '%')
        </if>
        <if test="orderId != null and orderId != ''">
            and t1.id like concat('%', #{orderId}, '%')
        </if>
        <if test="defrayTimeStart != null and defrayTimeStart != '' and defrayTimeEnd != null and defrayTimeEnd != ''">
            and t1.defray_time between #{defrayTimeStart} and #{defrayTimeEnd}
        </if>
        <if test="phone != null and phone != ''">
            and t2.phone like concat('%', #{phone}, '%')
        </if>
        <if test="orderStatus != null and orderStatus != ''">
            and t1.order_status = #{orderStatus}
        </if>
        order by t1.create_time desc
    </select>

    <!--查询订单详情-->
    <select id="getOrderDetailsById" parameterType="java.lang.String"
            resultType="com.xzsd.pc.order.entity.OrderDetails">
        select
        t1.order_id orderId,
        t1.user_id userId,
        t1.goods_id goodsId,
        t2.goods_name goodsName,
        t1.buy_number buyNumber,
        t1.total_price totalPrice,
        t2.selling_price sellingPrice,
        t2.old_price oldPrice
        from t_order_details t1, t_goods_info t2
        where t1.order_id = #{orderId}
        and t1.goods_id = t2.id
    </select>

    <!--修改订单状态-->
    <update id="updateOrderStatus" parameterType="com.xzsd.pc.order.entity.OrderInfo">
        update t_order_info
        set
            order_status = #{orderStatus},
            update_user = #{loginId},
            update_time = now(),
            version = version + 1
        where id = #{orderId}
    </update>
</mapper>